
Pipeline is successful but the ingress url is not getting created


pipeline {
    agent any

    environment {
        DOCKERHUB_CREDENTIALS = credentials('dockerhub-credentials')
        DOCKERHUB_USERNAME = 'kastrov'
        AWS_REGION = 'us-east-1'
        EKS_CLUSTER_NAME = 'kastro-cluster'
        NAMESPACE = 'ecommerce'
    }

    stages {

        /* -------------------- CHECKOUT CODE -------------------- */
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/KastroVKiran/Micro-Ecommerce.git'
                echo "‚úÖ Code checked out successfully"
            }
        }

        /* -------------------- BUILD SERVICES -------------------- */
        stage('Build User Service') {
            steps {
                dir('ecommerce-microservices/services/user-service') {
                    script {
                        docker.build("${DOCKERHUB_USERNAME}/user-service:${BUILD_NUMBER}")
                        docker.build("${DOCKERHUB_USERNAME}/user-service:latest")
                    }
                }
            }
        }

        stage('Build Product Service') {
            steps {
                dir('ecommerce-microservices/services/product-service') {
                    script {
                        docker.build("${DOCKERHUB_USERNAME}/product-service:${BUILD_NUMBER}")
                        docker.build("${DOCKERHUB_USERNAME}/product-service:latest")
                    }
                }
            }
        }

        stage('Build Cart Service') {
            steps {
                dir('ecommerce-microservices/services/cart-service') {
                    script {
                        docker.build("${DOCKERHUB_USERNAME}/cart-service:${BUILD_NUMBER}")
                        docker.build("${DOCKERHUB_USERNAME}/cart-service:latest")
                    }
                }
            }
        }

        stage('Build Order Service') {
            steps {
                dir('ecommerce-microservices/services/order-service') {
                    script {
                        docker.build("${DOCKERHUB_USERNAME}/order-service:${BUILD_NUMBER}")
                        docker.build("${DOCKERHUB_USERNAME}/order-service:latest")
                    }
                }
            }
        }

        stage('Build Payment Service') {
            steps {
                dir('ecommerce-microservices/services/payment-service') {
                    script {
                        docker.build("${DOCKERHUB_USERNAME}/payment-service:${BUILD_NUMBER}")
                        docker.build("${DOCKERHUB_USERNAME}/payment-service:latest")
                    }
                }
            }
        }

        /* -------------------- BUILD FRONTEND -------------------- */
        stage('Build Frontend') {
            steps {
                dir('ecommerce-microservices/frontend') {
                    script {
                        docker.build("${DOCKERHUB_USERNAME}/ecommerce-frontend:${BUILD_NUMBER}")
                        docker.build("${DOCKERHUB_USERNAME}/ecommerce-frontend:latest")
                    }
                }
            }
        }

        /* -------------------- PUSH ALL IMAGES -------------------- */
        stage('Push Images to DockerHub') {
            steps {
                script {
                    docker.withRegistry('https://registry.hub.docker.com', 'dockerhub-credentials') {

                        docker.image("${DOCKERHUB_USERNAME}/user-service:${BUILD_NUMBER}").push()
                        docker.image("${DOCKERHUB_USERNAME}/user-service:latest").push()

                        docker.image("${DOCKERHUB_USERNAME}/product-service:${BUILD_NUMBER}").push()
                        docker.image("${DOCKERHUB_USERNAME}/product-service:latest").push()

                        docker.image("${DOCKERHUB_USERNAME}/cart-service:${BUILD_NUMBER}").push()
                        docker.image("${DOCKERHUB_USERNAME}/cart-service:latest").push()

                        docker.image("${DOCKERHUB_USERNAME}/order-service:${BUILD_NUMBER}").push()
                        docker.image("${DOCKERHUB_USERNAME}/order-service:latest").push()

                        docker.image("${DOCKERHUB_USERNAME}/payment-service:${BUILD_NUMBER}").push()
                        docker.image("${DOCKERHUB_USERNAME}/payment-service:latest").push()

                        docker.image("${DOCKERHUB_USERNAME}/ecommerce-frontend:${BUILD_NUMBER}").push()
                        docker.image("${DOCKERHUB_USERNAME}/ecommerce-frontend:latest").push()
                    }
                }
            }
        }

        /* -------------------- UPDATE KUBECONFIG -------------------- */
        stage('Update Kubeconfig') {
            steps {
                sh """
                    aws eks update-kubeconfig \
                      --name ${EKS_CLUSTER_NAME} \
                      --region ${AWS_REGION}
                """
            }
        }

        /* -------------------- DEPLOY TO EKS -------------------- */
        stage('Deploy to EKS') {
            steps {
                sh "kubectl apply -f ecommerce-microservices/kubernetes/namespace.yaml"
                sh "kubectl apply -f ecommerce-microservices/kubernetes/configmaps/secrets.yaml"
                sh "kubectl apply -f ecommerce-microservices/kubernetes/databases/"
                sh "kubectl apply -f ecommerce-microservices/kubernetes/services/"
                sh "kubectl apply -f ecommerce-microservices/kubernetes/gateway/ingress.yaml"
            }
        }

        /* -------------------- VERIFY DEPLOYMENT -------------------- */
        stage('Verify Deployment') {
            steps {
                sh "kubectl get pods -n ${NAMESPACE}"
                sh "kubectl get svc -n ${NAMESPACE}"
                sh "kubectl get ingress -n ${NAMESPACE}"
            }
        }
    }

    post {
        always {
            sh "docker system prune -f || true"
        }
        success {
            echo 'üéâ Deployment Success!'
        }
        failure {
            echo '‚ùå Pipeline Failed'
        }
    }
}
